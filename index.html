<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registry Inventory</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            text-align: center;
            color: #4CAF50;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        select, input[type="text"] {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .radio-group label {
            font-weight: normal;
        }
        .input-with-buttons {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .input-with-buttons input {
            flex-grow: 1;
        }
        .inc-dec-btn {
            background-color: #ddd;
            border: 1px solid #ccc;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
        }
        .inc-dec-btn:hover {
            background-color: #ccc;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        .add-btn, .download-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            flex-grow: 1;
        }
        .add-btn:hover, .download-btn:hover {
            background-color: #45a049;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #4CAF50;
            color: white;
        }
        .delete-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-btn:hover {
            background-color: #e53935;
        }
        .download-btn-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        .download-raw-btn {
            background-color: #9c27b0;
            padding: 12px 25px;
        }
        .download-raw-btn:hover {
            background-color: #8e24aa;
        }
        .entry-button {
            border: none;
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
            border-radius: 4px;
            display: block;
            text-align: center;
            white-space: pre-line;
        }
        .good-btn {
            background-color: green;
            color: white;
        }
        .partial-btn {
            background-color: yellow;
            color: black;
        }
        .damaged-btn {
            background-color: red;
            color: white;
        }
        .binding-btn {
            background-color: #007bff;
            color: white;
        }
        .multi-volume-container {
            display: none;
            margin-top: 15px;
        }
        .multi-volume-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .multi-volume-row input {
            flex-grow: 1;
        }
        .add-row-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .remove-row-btn {
            background-color: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .volume-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .volume-table th, .volume-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .volume-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Registry Inventory Generator</h1>
        <div class="form-group">
            <label for="office">Registry Office:</label>
            <select id="office">
                <option value="Bhagalpur">Bhagalpur</option>
                <option value="Bihpur">Bihpur</option>
                <option value="Kahalgaon">Kahalgaon</option>
                <option value="Banka">Banka</option>
            </select>
        </div>
        <div class="form-group">
            <label>Document Type:</label>
            <div class="radio-group">
                <input type="radio" id="volume" name="docType" value="Volume" checked>
                <label for="volume">Volume</label>
                <input type="radio" id="multi-volume" name="docType" value="MultiVolume">
                <label for="multi-volume">Multiple Volumes</label>
                <input type="radio" id="index" name="docType" value="Index">
                <label for="index">Index</label>
            </div>
        </div>
        
        <!-- Regular Volume/Index inputs -->
        <div id="regular-inputs">
            <div class="form-group">
                <label for="year">Year:</label>
                <input type="text" id="year" placeholder="e.g., 1990">
            </div>
            <div class="form-group">
                <label for="prep-year">Preparation Year (Optional):</label>
                <input type="text" id="prep-year" placeholder="e.g., 1995">
            </div>
            <div class="form-group">
                <label id="doc-label" for="doc-value">Volume Numbers:</label>
                <div class="input-with-buttons">
                    <input type="text" id="doc-value" placeholder="e.g., 1, 2, 3sc">
                    <button class="inc-dec-btn" id="decrease-btn" onclick="incDecNumber(-1)">-</button>
                    <button class="inc-dec-btn" id="increase-btn" onclick="incDecNumber(1)">+</button>
                </div>
            </div>
        </div>
        
        <!-- Multiple Volume inputs -->
        <div id="multi-volume-inputs" class="multi-volume-container">
            <div id="multi-volume-rows">
                <div class="multi-volume-row">
                    <input type="text" class="multi-year" placeholder="Year">
                    <input type="text" class="multi-vol" placeholder="Volume Number">
                    <button class="remove-row-btn" onclick="removeRow(this)" disabled>×</button>
                </div>
                <div class="multi-volume-row">
                    <input type="text" class="multi-year" placeholder="Year">
                    <input type="text" class="multi-vol" placeholder="Volume Number">
                    <button class="remove-row-btn" onclick="removeRow(this)">×</button>
                </div>
            </div>
            <button class="add-row-btn" onclick="addMultiVolumeRow()">+ Add Another Volume</button>
        </div>
        
        <div class="form-group">
            <label>Present Condition:</label>
            <div class="radio-group">
                <div><input type="radio" id="good" name="condition" value="Good" checked>
                <label for="good">Good</label></div>
                <div><input type="radio" id="partial" name="condition" value="Partial Damage">
                <label for="partial">Partial Damage</label></div>
                <div><input type="radio" id="damaged" name="condition" value="Completely Damaged">
                <label for="damaged">Completely Damaged</label></div>
                <div><input type="radio" id="binding" name="condition" value="Need binding">
                <label for="binding">Need binding</label></div>
            </div>
        </div>
        <div class="button-group">
            <button class="add-btn" onclick="addEntry()">Add Entry</button>
        </div>
    </div>

    <!-- Download button above the tables -->
    <div class="download-btn-container">
        <button class="download-btn download-raw-btn" onclick="downloadRawData()">Download Raw Data (JSON)</button>
    </div>

    <div class="tables-container">
        <div class="container">
            <h2>Volumes Inventory</h2>
            <table id="volume-table">
                <thead>
                    <tr>
                        <th>Office</th>
                        <th>Year</th>
                        <th>Volumes</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="container">
            <h2>Multiple Volumes Inventory</h2>
            <table id="multi-table">
                <thead>
                    <tr>
                        <th>Office</th>
                        <th>Year Group</th>
                        <th>Volume Set</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        
        <div class="container">
            <h2>Indexes Inventory</h2>
            <table id="index-table">
                <thead>
                    <tr>
                        <th>Office</th>
                        <th>Year</th>
                        <th>Indexes</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        
    </div>

    <script>
        let volumesData = [];
        let indexesData = [];
        let multiVolumesData = [];
        let lastOffice = document.getElementById('office').value;

        // Show/hide appropriate input fields based on document type
        document.querySelectorAll('input[name="docType"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                const regularInputs = document.getElementById('regular-inputs');
                const multiVolumeInputs = document.getElementById('multi-volume-inputs');
                
                if (event.target.value === 'MultiVolume') {
                    regularInputs.style.display = 'none';
                    multiVolumeInputs.style.display = 'block';
                } else {
                    regularInputs.style.display = 'block';
                    multiVolumeInputs.style.display = 'none';
                }
                
                // Update label and input behavior
                const label = document.getElementById('doc-label');
                const docValueInput = document.getElementById('doc-value');
                const incDecButtons = document.querySelectorAll('.inc-dec-btn');
                
                if (event.target.value === 'Volume') {
                    label.textContent = 'Volume Numbers:';
                    docValueInput.placeholder = 'e.g., 1, 2, 3sc';
                    incDecButtons.forEach(btn => btn.style.display = 'inline-block');
                } else if (event.target.value === 'Index') {
                    label.textContent = 'Index Letters:';
                    docValueInput.placeholder = 'e.g., A, B, D';
                    docValueInput.value = docValueInput.value.toUpperCase();
                    incDecButtons.forEach(btn => btn.style.display = 'none');
                }
            });
        });

        // Event listener for office change
        document.getElementById('office').addEventListener('change', () => {
            const currentOffice = document.getElementById('office').value;
            if (currentOffice !== lastOffice) {
                document.getElementById('year').value = '';
                document.getElementById('prep-year').value = '';
                document.getElementById('doc-value').value = '';
                lastOffice = currentOffice;
            }
        });

        document.getElementById('doc-value').addEventListener('input', (event) => {
            if (document.getElementById('index').checked) {
                event.target.value = event.target.value.toUpperCase();
            }
        });

        // Increment/Decrement logic for Volume numbers
        function incDecNumber(change) {
            const docValueInput = document.getElementById('doc-value');
            let currentValue = docValueInput.value.trim();
            
            if (/^\d+$/.test(currentValue)) {
                let num = parseInt(currentValue);
                if (!isNaN(num)) {
                    num = Math.max(1, num + change);
                    docValueInput.value = num;
                }
            } else if (currentValue === '') {
                 docValueInput.value = 1;
            }
        }

        // Multi-volume functions
        function addMultiVolumeRow() {
            const container = document.getElementById('multi-volume-rows');
            const newRow = document.createElement('div');
            newRow.className = 'multi-volume-row';
            newRow.innerHTML = `
                <input type="text" class="multi-year" placeholder="Year">
                <input type="text" class="multi-vol" placeholder="Volume Number">
                <button class="remove-row-btn" onclick="removeRow(this)">×</button>
            `;
            container.appendChild(newRow);
        }

        function removeRow(button) {
            const row = button.parentNode;
            const container = document.getElementById('multi-volume-rows');
            if (container.children.length > 2) {
                container.removeChild(row);
            }
        }

        function addEntry() {
            const office = document.getElementById('office').value;
            const docType = document.querySelector('input[name="docType"]:checked').value;
            const condition = document.querySelector('input[name="condition"]:checked').value;

            if (!office) {
                alert('Please select an office.');
                return;
            }

            if (docType === 'MultiVolume') {
                // Handle multiple volumes
                const yearInputs = document.querySelectorAll('.multi-year');
                const volInputs = document.querySelectorAll('.multi-vol');
                
                const volumes = [];
                let hasEmpty = false;
                
                for (let i = 0; i < yearInputs.length; i++) {
                    const year = yearInputs[i].value.trim();
                    const vol = volInputs[i].value.trim();
                    
                    if (!year || !vol) {
                        hasEmpty = true;
                        continue;
                    }
                    
                    volumes.push({ year, vol });
                }
                
                if (hasEmpty) {
                    alert('Please fill in all year and volume fields for multiple volumes.');
                    return;
                }
                
                if (volumes.length === 0) {
                    alert('Please add at least one volume.');
                    return;
                }
                
                // Sort by year to find the earliest year
                volumes.sort((a, b) => parseInt(a.year) - parseInt(b.year));
                const earliestYear = volumes[0].year;
                
                // Add to multiVolumesData
                multiVolumesData.push({
                    office: office,
                    year: earliestYear,
                    volumes: volumes,
                    condition: condition
                });
                
                renderMultiTable();
                
            } else {
                // Handle regular volume or index
                const year = document.getElementById('year').value.trim();
                const prepYear = document.getElementById('prep-year').value.trim();
                const docValue = document.getElementById('doc-value').value.trim();

                if (!year || !docValue) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                // Format the year with preparation year if provided
                const displayYear = prepYear ? `${year}/${prepYear}` : year;
                const entries = docValue.split(',').map(item => item.trim());

                if (docType === 'Volume') {
                    mergeEntries(volumesData, office, displayYear, entries, condition);
                    renderTable('volume-table', volumesData, true);
                } else {
                    mergeEntries(indexesData, office, displayYear, entries, condition);
                    renderTable('index-table', indexesData, false);
                }
            }
        }

        function mergeEntries(dataArray, office, year, newEntries, condition) {
            const existingEntryIndex = dataArray.findIndex(entry => entry.office === office && entry.year === year);
            
            if (existingEntryIndex !== -1) {
                const existingEntry = dataArray[existingEntryIndex];
                newEntries.forEach(entry => {
                    const existingValueIndex = existingEntry.values.findIndex(val => val.value === entry);
                    if (existingValueIndex === -1) {
                        existingEntry.values.push({ value: entry, condition: condition });
                    }
                });
            } else {
                const newValues = newEntries.map(entry => ({ value: entry, condition: condition }));
                dataArray.push({
                    office: office,
                    year: year,
                    values: newValues
                });
            }
        }

        function renderTable(tableId, data, isVolume) {
            const tableBody = document.querySelector(`#${tableId} tbody`);
            tableBody.innerHTML = '';
            data.forEach((entry, mainIndex) => {
                const row = tableBody.insertRow();
                const officeCell = row.insertCell(0);
                const yearCell = row.insertCell(1);
                const valuesCell = row.insertCell(2);
                
                officeCell.textContent = entry.office;
                yearCell.textContent = entry.year;

                entry.values.forEach((val, subIndex) => {
                    const btn = document.createElement('button');
                    btn.textContent = val.value;
                    btn.className = 'entry-button';
                    
                    if (val.condition === 'Good') {
                        btn.classList.add('good-btn');
                    } else if (val.condition === 'Partial Damage') {
                        btn.classList.add('partial-btn');
                    } else if (val.condition === 'Completely Damaged') {
                        btn.classList.add('damaged-btn');
                    } else if (val.condition === 'Need binding') {
                        btn.classList.add('binding-btn');
                    }
                    
                    btn.onclick = () => deleteEntry(tableId, mainIndex, subIndex);
                    valuesCell.appendChild(btn);
                });
            });
        }

        function renderMultiTable() {
            const tableBody = document.querySelector('#multi-table tbody');
            tableBody.innerHTML = '';
            
            multiVolumesData.forEach((entry, index) => {
                const row = tableBody.insertRow();
                const officeCell = row.insertCell(0);
                const yearCell = row.insertCell(1);
                const valuesCell = row.insertCell(2);
                
                officeCell.textContent = entry.office;
                yearCell.textContent = entry.year;
                
                const btn = document.createElement('button');
                btn.className = 'entry-button';
                
                if (entry.condition === 'Good') {
                    btn.classList.add('good-btn');
                } else if (entry.condition === 'Partial Damage') {
                    btn.classList.add('partial-btn');
                } else if (entry.condition === 'Completely Damaged') {
                    btn.classList.add('damaged-btn');
                } else if (entry.condition === 'Need binding') {
                    btn.classList.add('binding-btn');
                }
                
                // Create multiline text for the button
                let buttonText = '';
                entry.volumes.forEach((v, idx) => {
                    buttonText += `${v.year}-${v.vol}`;
                    if (idx < entry.volumes.length - 1) buttonText += '\n';
                });
                btn.textContent = buttonText;
                
                btn.onclick = () => deleteMultiEntry(index);
                valuesCell.appendChild(btn);
            });
        }

        function deleteEntry(tableId, mainIndex, subIndex) {
            const dataArray = tableId === 'volume-table' ? volumesData : 
                            tableId === 'index-table' ? indexesData : null;
            
            if (!dataArray) return;
            
            const confirmDelete = confirm(`Do you want to delete this entry?`);
            if (confirmDelete) {
                const entry = dataArray[mainIndex];
                entry.values.splice(subIndex, 1);

                if (entry.values.length === 0) {
                    dataArray.splice(mainIndex, 1);
                }
                
                renderTable(tableId, dataArray, tableId === 'volume-table');
            }
        }
        
        function deleteMultiEntry(index) {
            const confirmDelete = confirm(`Do you want to delete this multi-volume entry?`);
            if (confirmDelete) {
                multiVolumesData.splice(index, 1);
                renderMultiTable();
            }
        }
        
        function downloadRawData() {
            const filename = prompt("Enter filename for JSON data (e.g., inventory.json):", "raw-data.json");
            if (!filename) return;
            
            // Prepare data for JSON export
            const jsonData = [];
            
            // Add volumes data
            volumesData.forEach(entry => {
                entry.values.forEach(val => {
                    // Extract year and preparation year
                    const yearParts = entry.year.split('/');
                    const originalYear = yearParts[0];
                    const preparationYear = yearParts.length > 1 ? yearParts[1] : '';
                    
                    jsonData.push({
                        "office": entry.office,
                        "year": originalYear,
                        "preparationYear": preparationYear,
                        "docType": "Volume",
                        "docNumber": val.value,
                        "condition": val.condition,
                        "isSingle": "true",
                        "bindedWith": ""
                    });
                });
            });
            
            // Add indexes data
            indexesData.forEach(entry => {
                entry.values.forEach(val => {
                    // Extract year and preparation year
                    const yearParts = entry.year.split('/');
                    const originalYear = yearParts[0];
                    const preparationYear = yearParts.length > 1 ? yearParts[1] : '';
                    
                    jsonData.push({
                        "office": entry.office,
                        "year": originalYear,
                        "preparationYear": preparationYear,
                        "docType": "Index",
                        "docNumber": val.value,
                        "condition": val.condition,
                        "isSingle": "true",
                        "bindedWith": ""
                    });
                });
            });
            
            // Add multi-volume data
            multiVolumesData.forEach(entry => {
                entry.volumes.forEach(v => {
                    const bindedWith = entry.volumes
                        .filter(other => other !== v)
                        .map(other => `${entry.office}-${other.year}-${other.vol}`)
                        .join('|');
                    
                    jsonData.push({
                        "office": entry.office,
                        "year": v.year,
                        "volNo": v.vol,
                        "condition": entry.condition,
                        "isSingle": "false",
                        "bindedWith": bindedWith
                    });
                });
            });
            
            // Create and download JSON file
            const jsonString = JSON.stringify(jsonData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename.endsWith('.json') ? filename : `${filename}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        window.addEventListener('beforeunload', function(event) {
            if (volumesData.length > 0 || indexesData.length > 0 || multiVolumesData.length > 0) {
                event.preventDefault();
                event.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>

